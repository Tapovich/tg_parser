# Исправление проблем с flood control и дублированием уведомлений

## Проблемы
1. **Flood control** - бот отправлял слишком много сообщений подряд
2. **Дублирование уведомлений** - бот уведомлял о старых постах при каждом перезапуске

## Решения

### 1. Защита от flood control
- ✅ Добавлена задержка 30 секунд между уведомлениями одному пользователю
- ✅ При ошибке flood control автоматическое ожидание 5 минут
- ✅ Задержка 2 секунды между отправками разным админам
- ✅ Логирование времени отправки для каждого пользователя

### 2. Уведомления только о новых постах
- ✅ Время последней проверки сохраняется в базе данных
- ✅ RSS: проверка по дате публикации записи
- ✅ Telegram: проверка по дате сообщения
- ✅ Пропуск постов, которые уже были обработаны

### 3. Новые команды управления
- `/check_times` - показать время последней проверки всех источников
- `/reset_checks` - сбросить время проверки (проверить заново все посты)

### 4. Улучшенная логика мониторинга
- ✅ RSS: проверка `published_parsed` и `updated_parsed`
- ✅ Telegram: проверка `message.date`
- ✅ Сохранение времени проверки в БД для каждого источника
- ✅ Автоматический пропуск старых записей

## Технические детали

### База данных
Добавлены методы:
- `get_setting(key)` - получить настройку
- `set_setting(key, value)` - установить настройку

### ContentMonitor
Добавлены методы:
- `_get_last_check_time(source_key)` - получить время последней проверки
- `_update_last_check_time(source_key)` - обновить время проверки
- `safe_send_message()` - безопасная отправка с защитой от flood

### Переменные окружения
- `last_check_rss_[url]` - время последней проверки RSS
- `last_check_tg_[channel]` - время последней проверки Telegram

## Результат
- ✅ Нет больше flood control ошибок
- ✅ Уведомления только о действительно новых постах
- ✅ Автоматическая защита от спама
- ✅ Возможность сброса времени проверки при необходимости

## Использование
1. Бот автоматически защищен от flood control
2. Для проверки времени: `/check_times`
3. Для сброса проверки: `/reset_checks`
4. Все уведомления теперь только о новых постах 