# Фильтр даты отсечения

## Проблема
Бот продолжал отправлять старые посты, несмотря на отслеживание по ID. Нужно добавить фильтр по дате.

## Решение

### 1. Дата отсечения
Установлена дата отсечения: **27 июля 2025 года**
```python
CUTOFF_DATE = datetime(2025, 7, 27, tzinfo=timezone.utc)
```

### 2. Фильтрация Telegram сообщений
```python
# Проверяем, что сообщение не старше CUTOFF_DATE
if message.date < CUTOFF_DATE:
    logger.debug(f"Пропускаем сообщение старше {CUTOFF_DATE}: {message.id} от {message.date}")
    continue
```

### 3. Фильтрация RSS записей
```python
# Проверяем, что запись не старше CUTOFF_DATE
if pub_date and pub_date < CUTOFF_DATE:
    logger.debug(f"Пропускаем RSS запись старше {CUTOFF_DATE}: {pub_date}")
    continue
```

## Как работает фильтр

### Telegram каналы:
1. **Получаем сообщения** из канала
2. **Проверяем ID** (пропускаем уже обработанные)
3. **Проверяем дату** (пропускаем старше 27 июля 2025)
4. **Проверяем ключевые слова** (обрабатываем только релевантные)
5. **Отправляем уведомления** (только новые и релевантные)

### RSS источники:
1. **Получаем записи** из RSS
2. **Проверяем дату публикации** (пропускаем старше 27 июля 2025)
3. **Проверяем ключевые слова** (обрабатываем только релевантные)
4. **Отправляем уведомления** (только новые и релевантные)

## Команды для управления

### Проверка даты отсечения:
```bash
/check_cutoff    # Показать дату отсечения и текущее время
```

### Диагностика:
```bash
/check_times     # Показать время и ID
/check_channel @name  # Проверить конкретный канал
/bot_status      # Общий статус
```

### Сброс и проверка:
```bash
/reset_ids       # Сбросить ID сообщений
/force_monitor   # Принудительный мониторинг
```

## Логи для проверки

### Успешная фильтрация:
```
DEBUG - Обрабатываем новое сообщение 12346: 2025-07-27 15:30:00+00:00
DEBUG - Найдены ключевые слова: ['Telegram', 'TON']
INFO - Добавлен TG контент #456: Новый пост...
```

### Пропуск старых сообщений:
```
DEBUG - Пропускаем сообщение старше 2025-07-27 00:00:00+00:00: 12345 от 2025-07-26 15:30:00+00:00
DEBUG - Пропускаем RSS запись старше 2025-07-27 00:00:00+00:00: 2025-07-26 10:00:00+00:00
```

## Преимущества фильтра

### 1. Защита от старых постов
- ✅ Игнорирует все посты до 27 июля 2025
- ✅ Не спамит старыми сообщениями
- ✅ Фокус на новых постах

### 2. Точность
- ✅ Проверка даты для каждого сообщения
- ✅ Работает с Telegram и RSS
- ✅ Логирование для диагностики

### 3. Производительность
- ✅ Быстрая фильтрация по дате
- ✅ Меньше обработки старых данных
- ✅ Экономия ресурсов

## Технические детали

### Константа даты отсечения:
```python
CUTOFF_DATE = datetime(2025, 7, 27, tzinfo=timezone.utc)
```

### Проверка в Telegram:
```python
if message.date < CUTOFF_DATE:
    continue
```

### Проверка в RSS:
```python
if pub_date and pub_date < CUTOFF_DATE:
    continue
```

## Развертывание

### 1. Залить изменения:
```bash
git add .
git commit -m "Add date cutoff filter for posts after July 27, 2025"
git push
```

### 2. Проверить работу:
```bash
/check_cutoff    # Проверить дату отсечения
/reset_ids       # Сбросить ID сообщений
/force_monitor   # Запустить проверку
```

### 3. Мониторинг:
- Проверить логи на Railway
- Убедиться, что старые посты пропускаются
- Проверить, что новые посты обрабатываются

## Статус
- ✅ Добавлен фильтр даты отсечения
- ✅ Команда проверки даты
- ✅ Фильтрация Telegram и RSS
- ✅ Защита от старых постов
- ✅ Логирование для диагностики

## Результат
Бот теперь обрабатывает только посты, опубликованные после 27 июля 2025 года, полностью исключая старые сообщения. 